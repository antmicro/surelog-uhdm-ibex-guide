From 2c5f32007835592af41a03fda910d0875e04f598 Mon Sep 17 00:00:00 2001
From: Kamil Rakoczy <krakoczy@antmicro.com>
Date: Mon, 10 Jan 2022 13:18:31 +0100
Subject: [PATCH 1/2] Add always_comb_nolatch_5 test

Signed-off-by: Kamil Rakoczy <krakoczy@antmicro.com>
---
 tests/verilog/always_comb_nolatch_5.ys | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)
 create mode 100644 tests/verilog/always_comb_nolatch_5.ys

diff --git a/tests/verilog/always_comb_nolatch_5.ys b/tests/verilog/always_comb_nolatch_5.ys
new file mode 100644
index 000000000..d9b3b4eae
--- /dev/null
+++ b/tests/verilog/always_comb_nolatch_5.ys
@@ -0,0 +1,22 @@
+read_verilog -sv <<EOF
+module top();
+logic z;
+logic [3:0] a;
+logic [3:0] b;
+function automatic logic [3:0] transpose(logic [3:0] in);
+  logic [3:0] transpose;
+  transpose = '0;
+  for (int j=0; j<4; j++) begin
+    transpose[j] = in[3 - j];
+  end 
+endfunction 
+always_comb begin
+  unique case (z)
+    1'b0: a = '0;
+    1'b1: a = transpose(b);
+    default: a = '0;
+  endcase
+end
+endmodule
+EOF
+proc
-- 
2.33.1

From 77fb96b368af807a0ab4dd249a57333680654b48 Mon Sep 17 00:00:00 2001
From: Kamil Rakoczy <krakoczy@antmicro.com>
Date: Mon, 10 Jan 2022 13:19:38 +0100
Subject: [PATCH 2/2] Always look for variables for nosync

Signed-off-by: Kamil Rakoczy <krakoczy@antmicro.com>
---
 frontends/ast/simplify.cc | 15 ++++++---------
 1 file changed, 6 insertions(+), 9 deletions(-)

diff --git a/frontends/ast/simplify.cc b/frontends/ast/simplify.cc
index 18b1e1e11..653c64e65 100644
--- a/frontends/ast/simplify.cc
+++ b/frontends/ast/simplify.cc
@@ -2341,15 +2341,12 @@ bool AstNode::simplify(bool const_fold, bool at_zero, bool in_lvalue, int stage,
 	{
 		expand_genblock(str + ".");
 
-		// if this is an autonamed block is in an always_comb
-		if (current_always && current_always->attributes.count(ID::always_comb)
-				&& str.at(0) == '$')
-			// track local variables in this block so we can consider adding
-			// nosync once the block has been fully elaborated
-			for (AstNode *child : children)
-				if (child->type == AST_WIRE &&
-						!child->attributes.count(ID::nosync))
-					mark_auto_nosync(this, child);
+		// track local variables in this block so we can consider adding
+		// nosync once the block has been fully elaborated
+		for (AstNode *child : children)
+			if (child->type == AST_WIRE &&
+					!child->attributes.count(ID::nosync))
+				mark_auto_nosync(this, child);
 
 		std::vector<AstNode*> new_children;
 		for (size_t i = 0; i < children.size(); i++)
-- 
2.33.1

